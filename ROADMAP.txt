================================================================================
TABULA-RB: ROADMAP TO 100% FEATURE PARITY WITH TABULA-JAVA
================================================================================

Current Status: 166 tests passing, 82.43% code coverage
Overall Grade: C+ (functional but incomplete)

================================================================================
PHASE 1: CRITICAL TEXT EXTRACTION FIXES
================================================================================
Priority: CRITICAL
Estimated Tests: ~40 new tests

1.1 Font Encoding & CMap Support
    Location: lib/tabula/pdf/text_stripper.rb

    Problem: Text extraction returns null bytes or garbled text for PDFs
    using embedded fonts with custom encodings (us-017.pdf, china.pdf)

    Tasks:
    - [ ] Implement ToUnicode CMap parsing
    - [ ] Handle Identity-H and Identity-V encodings
    - [ ] Support Type0/CIDFont composite fonts
    - [ ] Add CMap file loading for standard encodings
    - [ ] Parse /Encoding dictionary entries
    - [ ] Handle /Differences array in encodings

    Reference: tabula-java uses PDFBox's PDFont.toUnicode()

    Tests needed:
    - [ ] test_unicode_chinese (china.pdf)
    - [ ] test_embedded_fonts (us-017.pdf, eu-002.pdf)
    - [ ] test_standard_encodings (WinAnsiEncoding, MacRomanEncoding)
    - [ ] test_identity_h_encoding

1.2 isPrintable() Character Filtering
    Location: lib/tabula/text/text_element.rb

    Problem: Java filters non-printable characters; Ruby includes them

    Tasks:
    - [ ] Port isPrintable() logic from TextElement.java
    - [ ] Filter control characters (0x00-0x1F except tab, newline)
    - [ ] Handle Unicode categories (Cc, Cf, Cs, Co)
    - [ ] Filter private use area characters

    Reference: TextElement.java lines 120-145

    Tests needed:
    - [ ] test_filters_null_bytes
    - [ ] test_filters_control_chars
    - [ ] test_preserves_whitespace
    - [ ] test_filters_replacement_char

1.3 Blank Cell Filtering in Spreadsheet Extractor
    Location: lib/tabula/extractors/spreadsheet.rb

    Problem: Ruby includes cells with only whitespace; Java filters them

    Tasks:
    - [ ] Add isBlank() check to cell text extraction
    - [ ] Normalize whitespace before blank check
    - [ ] Handle cells with only non-printable characters

    Reference: SpreadsheetExtractionAlgorithm.java lines 180-195

    Tests needed:
    - [ ] test_blank_cell_filtering
    - [ ] test_whitespace_only_cells
    - [ ] test_empty_table_regions

1.4 Font Metrics for Text Positioning
    Location: lib/tabula/pdf/text_stripper.rb

    Problem: Text element widths are approximated, causing column detection issues

    Tasks:
    - [ ] Extract font width tables from PDF
    - [ ] Calculate actual character advance widths
    - [ ] Handle kerning pairs
    - [ ] Support proportional fonts correctly
    - [ ] Implement getStringWidth() equivalent

    Reference: PDFBox's PDFont.getStringWidth()

    Tests needed:
    - [ ] test_proportional_font_widths
    - [ ] test_monospace_font_widths
    - [ ] test_kerning_handling

================================================================================
PHASE 2: RTL AND BIDIRECTIONAL TEXT SUPPORT
================================================================================
Priority: HIGH
Estimated Tests: ~15 new tests

2.1 RTL Text Detection
    Location: lib/tabula/text/text_chunk.rb

    Tasks:
    - [ ] Detect RTL scripts (Arabic, Hebrew)
    - [ ] Implement Unicode Bidi algorithm (UAX #9)
    - [ ] Handle mixed LTR/RTL text
    - [ ] Correct text element ordering in chunks

    Reference: tabula-java TextChunk.java RTL handling

    Tests needed:
    - [ ] test_arabic_text (arabic.pdf)
    - [ ] test_hebrew_text
    - [ ] test_mixed_bidi_text

2.2 RTL Table Extraction
    Location: lib/tabula/extractors/basic.rb

    Tasks:
    - [ ] Reverse column order for RTL tables
    - [ ] Handle RTL cell content
    - [ ] Proper text joining in RTL context

    Tests needed:
    - [ ] test_arabic_table_extraction
    - [ ] test_rtl_column_order

================================================================================
PHASE 3: CONFIGURABLE THRESHOLDS & PARAMETERS
================================================================================
Priority: HIGH
Estimated Tests: ~20 new tests

3.1 Extract Magic Numbers to Constants
    Locations: Multiple files

    Current magic numbers to extract:
    - RULING_THICKNESS_THRESHOLD = 8.0 (object_extractor.rb)
    - POINT_TOLERANCE = 0.01 (ruling.rb)
    - HORIZONTAL_TOLERANCE = 0.01 (ruling.rb)
    - VERTICAL_TOLERANCE = 0.01 (ruling.rb)
    - CHARACTER_DISTANCE_MULTIPLIER (text_chunk.rb)
    - LINE_SPACING_FACTOR (basic.rb)
    - COLUMN_GAP_THRESHOLD (basic.rb)

    Tasks:
    - [ ] Create Configuration class
    - [ ] Document all thresholds
    - [ ] Allow per-extraction overrides
    - [ ] Add sensible defaults

    Tests needed:
    - [ ] test_custom_ruling_threshold
    - [ ] test_custom_point_tolerance
    - [ ] test_custom_text_spacing

3.2 Extraction Options Validation
    Location: lib/tabula.rb, lib/tabula/cli.rb

    Tasks:
    - [ ] Validate area coordinates
    - [ ] Validate page ranges
    - [ ] Validate column specifications
    - [ ] Type checking for all options
    - [ ] Meaningful error messages

    Tests needed:
    - [ ] test_invalid_area_coordinates
    - [ ] test_invalid_page_range
    - [ ] test_invalid_method_option

================================================================================
PHASE 4: ALGORITHM IMPROVEMENTS
================================================================================
Priority: MEDIUM
Estimated Tests: ~25 new tests

4.1 Spanning Cell Detection
    Location: lib/tabula/extractors/spreadsheet.rb

    Problem: Cells that span multiple rows/columns not properly detected

    Tasks:
    - [ ] Detect horizontal spanning cells (missing vertical rulings)
    - [ ] Detect vertical spanning cells (missing horizontal rulings)
    - [ ] Implement cell merging logic
    - [ ] Add rowspan/colspan to Cell class

    Reference: SpreadsheetExtractionAlgorithm.java spanning cell logic

    Tests needed:
    - [ ] test_horizontal_spanning (spanning_cells.pdf)
    - [ ] test_vertical_spanning
    - [ ] test_complex_merged_cells

4.2 Nurminen Detection Algorithm
    Location: lib/tabula/detectors/nurminen.rb

    Current: Partially implemented

    Tasks:
    - [ ] Complete histogram analysis
    - [ ] Implement edge detection
    - [ ] Add text alignment clustering
    - [ ] Improve table area scoring
    - [ ] Handle multi-table pages

    Reference: NurminenDetectionAlgorithm.java

    Tests needed:
    - [ ] test_single_table_detection
    - [ ] test_multi_table_detection
    - [ ] test_no_table_detection
    - [ ] test_partial_table_detection

4.3 Generic Spatial Index
    Location: lib/tabula/core/spatial_index.rb

    Current: Uses arrays with linear search

    Tasks:
    - [ ] Implement R-tree or similar spatial index
    - [ ] Index text elements by bounding box
    - [ ] Index rulings by position
    - [ ] Support range queries
    - [ ] Support overlap queries

    Tests needed:
    - [ ] test_spatial_query_performance
    - [ ] test_overlap_detection
    - [ ] test_range_queries

4.4 Page Rotation Handling
    Location: lib/tabula/pdf/object_extractor.rb

    Tasks:
    - [ ] Read /Rotate page attribute
    - [ ] Transform coordinates for rotated pages
    - [ ] Handle 90/180/270 degree rotations
    - [ ] Adjust rulings for rotation

    Reference: rotated_page.pdf test case

    Tests needed:
    - [ ] test_90_degree_rotation
    - [ ] test_180_degree_rotation
    - [ ] test_270_degree_rotation

================================================================================
PHASE 5: COMPREHENSIVE TEST COVERAGE
================================================================================
Priority: MEDIUM
Estimated Tests: ~60 new tests

5.1 Port All Java Test Cases
    Reference: tabula-java/src/test/java/technology/tabula/

    Tests to port:
    - [ ] TestBasicExtractor.java (15 tests)
    - [ ] TestSpreadsheetExtractor.java (25 tests)
    - [ ] TestTable.java (10 tests)
    - [ ] TestRuling.java (20 tests)
    - [ ] TestCell.java (8 tests)
    - [ ] TestObjectExtractor.java (12 tests)
    - [ ] TestNurminenDetector.java (10 tests)
    - [ ] TestCommandLineApp.java (15 tests)
    - [ ] TestUtils.java (5 tests)
    - [ ] TestRectangle.java (10 tests)
    - [ ] TestTextElement.java (8 tests)
    - [ ] TestTextChunk.java (12 tests)

5.2 Edge Case Tests

    - [ ] test_empty_pdf
    - [ ] test_password_protected_pdf (encrypted.pdf)
    - [ ] test_corrupted_pdf
    - [ ] test_very_large_pdf
    - [ ] test_pdf_with_images_only
    - [ ] test_pdf_with_no_tables
    - [ ] test_pdf_with_headers_footers

5.3 CSV Comparison Tests

    For each fixture:
    - [ ] argentina_diputados_voting_record.pdf -> .csv
    - [ ] schools.pdf -> .csv
    - [ ] spanning_cells.pdf -> .csv
    - [ ] twotables.pdf -> .csv
    - [ ] us-020.pdf -> .csv
    - [ ] frx_2012_disclosure.pdf -> .csv
    - [ ] indictb1h_14.pdf -> .csv

================================================================================
PHASE 6: PERFORMANCE OPTIMIZATION
================================================================================
Priority: LOW
Estimated Tests: ~10 benchmark tests

6.1 Profile Hot Paths

    Tasks:
    - [ ] Add benchmark suite
    - [ ] Profile text extraction
    - [ ] Profile ruling detection
    - [ ] Profile table construction
    - [ ] Identify bottlenecks

6.2 Optimize Critical Sections

    Tasks:
    - [ ] Cache spatial index queries
    - [ ] Memoize expensive calculations
    - [ ] Reduce object allocations
    - [ ] Consider native extensions for geometry

    Targets:
    - Text extraction: < 100ms per page
    - Table detection: < 200ms per page
    - Full extraction: < 500ms per page

6.3 Memory Optimization

    Tasks:
    - [ ] Stream large PDFs instead of loading fully
    - [ ] Release page resources after extraction
    - [ ] Limit text element retention

================================================================================
PHASE 7: API POLISH & DOCUMENTATION
================================================================================
Priority: LOW
Estimated Tests: ~5 new tests

7.1 API Improvements

    Tasks:
    - [ ] Add Table#to_hash, Table#to_json convenience methods
    - [ ] Add streaming writer support
    - [ ] Add progress callbacks for CLI
    - [ ] Add debug/verbose logging

7.2 Error Handling

    Tasks:
    - [ ] Create specific exception classes
    - [ ] Add error context to exceptions
    - [ ] Handle PDF reader errors gracefully
    - [ ] Add recovery options for partial failures

================================================================================
PHASE 8: NICE TO HAVES
================================================================================
Priority: OPTIONAL

8.1 Advanced Features
    - [ ] PDF/A validation
    - [ ] XFA form extraction
    - [ ] Table header detection
    - [ ] Auto-column type detection
    - [ ] Table title extraction

8.2 Output Formats
    - [ ] Excel (XLSX) writer
    - [ ] HTML table writer
    - [ ] Markdown table writer

8.3 Integration
    - [ ] Rails integration (Active Storage)
    - [ ] Async extraction support
    - [ ] Web service wrapper

================================================================================
METRICS & SUCCESS CRITERIA
================================================================================

Target: 100% feature parity with tabula-java

Metrics:
- Test count: 300+ (currently 166)
- Code coverage: 95%+ (currently 82.43%)
- All tabula-java test PDFs pass comparison
- Performance within 2x of Java implementation

Validation:
- Run both implementations on ICDAR 2013 dataset
- Compare outputs for all test fixtures
- Benchmark identical operations

================================================================================
IMPLEMENTATION ORDER
================================================================================

1. Phase 1.1 - Font Encoding (blocks everything else)
2. Phase 1.2 - isPrintable filtering
3. Phase 1.3 - Blank cell filtering
4. Phase 1.4 - Font metrics
5. Phase 3.1 - Configuration class
6. Phase 4.1 - Spanning cells
7. Phase 5.1 - Port Java tests
8. Phase 2 - RTL support
9. Phase 4.2 - Nurminen detection
10. Phase 4.3 - Spatial index
11. Phase 4.4 - Page rotation
12. Phase 3.2 - Validation
13. Phase 5.2/5.3 - Edge cases & CSV comparison
14. Phase 6 - Performance
15. Phase 7 - Polish
16. Phase 8 - Nice to haves

================================================================================
